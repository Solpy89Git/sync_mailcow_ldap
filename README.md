# sync_mailcow_ldap
Sync Mailcow LDAP Script (SMLS)

READ BEFORE USING!

Description

This script is designed to (temporarily and approximately) fix the abnormal synchronization behavior between Mailcow and LDAP.

The script consists of four components:

index

install

uninstall

run

The index script acts as the main controller. From here, you can start the other scripts and consult the logs.

The install script is the configurator. It will guide you step by step in entering your LDAP system and Mailcow system configuration data and will generate the necessary configuration files.

The uninstall script removes all files generated by the install script, cleaning up the system.

The run script is the core of the synchronization process. It executes queries, synchronizes users, creates new users, updates existing ones, and deactivates inactive accounts.

Use Cases

As mentioned earlier, this script is designed to manually synchronize users between Mailcow and LDAP (specifically Active Directory).

However, instead of a direct LDAP-Mailcow integration, I opted to use Keycloak following the development team‚Äôs recommendation. Due to a lack of explicit documentation and issues encountered with direct LDAP-Mailcow integration, I followed the guidance for Keycloak.

Even with Keycloak, I faced some challenges, but I eventually enabled SSO with Mailcow. However, since synchronization remained an issue, I developed this script.

WORKFLOW OVERVIEW:

üìå LDAP ‚Üí Keycloak ‚Üí Mailcow

LDAP stores the users.

Keycloak syncs users and acts as the authentication bridge with Mailcow.

Mailcow performs authentication and allows users to access SOGo (the webmail client).

(üìå Simplified Explanation: Users are stored in LDAP, synced through Keycloak, and authenticated via Mailcow.)

Issues and Workarounds

1) The script syncs users but overwrites passwords in the main database!

‚û°Ô∏è After running the script, all previous passwords will no longer be valid!

üõ† WORKAROUND:

If you are running Mailcow in a test or virtualized environment, take a snapshot before executing the script to enable rollback.

Perform a backup of the database so that you have a restore point.

Run tests in an appropriate non-production environment first.

2) LDAP passwords only work on the web client (SOGo), not on mail clients (Outlook, Thunderbird, etc.).

üõ† WORKAROUND:

If your users only use SOGo, this isn‚Äôt a problem.

Otherwise, encourage them to use the App Password feature, allowing them to generate custom passwords for their email clients.

Preliminary Testing

I conducted tests in the following environment:

üìå MAILCOW

Nightly - fcebe985 (Dockerized) on a Debian 12 Linux VM.

üìå LDAP

Active Directory on Windows Server 2019.

üìå KEYCLOAK

Dockerized on a Debian 12 Linux VM.

‚ö†Ô∏è Use this script with caution, and always test before deploying in production!

